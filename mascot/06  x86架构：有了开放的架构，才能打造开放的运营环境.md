# 06 | x86架构：有了开放的架构，才能打造开放的运营环境

## 计算机的工作模式是什么样的？

------

CPU 包括: 运算单元, 数据单元, 控制单元：

+ 运算单元：负责对数据的处理
+ 数据单元：包括 CPU 内部缓存和寄存器, 暂时存放数据和结果
+ 控制单元：获取下一条指令, 指导运算单元取数据, 计算, 存放结果

总线：连接 CPU 和其他设备

+ 地址总线：寻找地址
+ 控制总线：传递指令
+ 数据总线：传送数据

内存：

负责对数据的存储

### CPU 和内存是如何配合工作的？

内存中保存着多个进程的数据，每个进程的数据分为代码段和数据段。CPU 中的指令起始地址寄存器和数据起始地址寄存器保存着当前处理进程的代码段起始地址和数据段起始地址，这样在进程切换时就能知道当前的计算任务是哪个进程的。

CPU 控制单元中的指令指针寄存器存放着下一条指令在内存代码段中的地址，控制单元根据指令地址拿出指令，放入控制单元的指令寄存器。

当前指令的一部分交给了运算单元，另一部分交给数据单元，数据单元根据数据地址从内存数据段把数据读到数据寄存器，运算单元做完运算，产生的结果也暂存在数据寄存器。最终，会有指令将数据写回内存数据段。

## x86 开放, 统一, 兼容

------

当年 IBM 做的 PC 使用了英特尔的 8086 芯片作为CPU，因此有了 x86 架构。x86 架构成为了行业的开放事实标准，英特尔后来的 CPU 也要遵循标准、开放和兼容。

### 从 8086 的原理说起

8086 处理器内部有 8 个 16 位的通用寄存器，也就是 CPU 的数据单元。

控制单元的寄存器有：

- IP 寄存器：指令指针寄存器，指向代码段中下一条指令的位置，CPU 通过它把指令加载到指令队列，然后交给运算单元去执行
- CS：代码段寄存器，存放代码段的起始位置，代码段的偏移量放在 IP 寄存器中
- DS：数据段寄存器，存放数据段的起始位置，数据段的偏移量放在通用寄存器中
- SS：栈寄存器，秉承数据后进先出的原则，程序的函数调用信息会在栈寄存器中 push 或 pop
- ES：扩展寄存器

### 32 位处理器

为了在开放架构的基础上保持兼容，32 位处理器相比 8086 处理器做的改动：

- 将 8 个 16 位的通用寄存器扩展到 32 位，这样就兼容了 16 位和 8 位；
- IP 寄存器扩展为 32 位，兼容 16 位；
- 因为原先的段寄存器是 20 位的，不好兼容，所以换个思路，段寄存器仍是16位，段寄存器不再保存段的起始地址，起始地址放在内存中的一个表格上，表格用段描述符来组织，寄存器里保存的是在这个表格中的哪一项，称为选择子。这样，拿段起始地址就要先经过这个表格，为了快速拿到段起始地址，段寄存器会从内存中拿到 CPU 的描述符高速缓冲器中。在 32 位系统架构下，前一种模式称为实模式，后一种模式称为保护模式。当系统刚启动时是处于实模式的，后面可以切换为保护模式，这样可以获得更多的内存。