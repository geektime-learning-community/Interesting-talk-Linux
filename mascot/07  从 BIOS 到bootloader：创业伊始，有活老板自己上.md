# 07 | 从 BIOS 到bootloader：创业伊始，有活老板自己上

实模式只有 1MB 内存寻址空间(X86)，每段最多64K。

## BIOS 时期

------

ROM 只读存储器，ROM 固化了一些程序就是BIOS。用来初始化系统，一开始的内存空间比较小，只有 1M，最上面的64k映射为 BIOS，指针指向这64k，开始进行初始化，有2个事情，一个是检查硬件环境，另一个是建立中断程序和中断向量表，同时把结果显示在显示器上。

## bootloader 时期

------

BIOS 只是做初始化工作，真正安装系统了，首先要找系统。grub2是搞系统启动的，他把系统代码放在硬盘上，一般在第一个扇区，以 0xAA55 结束，512个字节，满足这个条件，就是系统启动的代码。grub2 要首先安装的是第一个扇区MBR主引导扇区，他在 BIOS 初始化完成之后进行。

接下来 grub2 就会把 boot.img 加载到内存，他做的最重要的事情就是加载 core.img 镜像。core.img 由diskboot.img，lzma_decompress.img 、kernel.img 组成。core.img 的的第一个扇区就是 diskboot.img，然后diskboot.img 解压 lzma_decompress.img， 再解压 kernel.img，再然后是各个模块对应的映像。

## 从实模式到保护模式

------

lzma_decompress在解压之前，调用real_to_prot。从实模式切换到保护模式，做的事情，启用分段，在内存里建立段描述表，将段寄存器里的段寄存器变成段选择子，指向某个段描述符，就能完成进程的切换。

然后启动分页，管理的内存大了，将内存分成大小相等的块，打开Gate20，第21根地址线的控制线，有空间了，对 kernel.img 解压缩，开始运行，是一堆.c文件。里面有主函数，显示出操作系统的列表，选择了一个操作系统。

再者开始调用 grub_menu_execute_entry()，开始执行选择的那一项，里面的linux16命令。表示装载指定的内核文件，并传递内核启动参数，于是 grub_cmd_linux() 函数被调用。

最后会读取linux内核头部的数据结构，加载到内存中来，检查通过，会加载整个linux内核镜像到内存，当都做完，调用grub_command_execute("boot",0,0)，开始真正的启动内核。

